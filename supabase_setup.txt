
-- COPIEZ TOUT CE CODE DANS L'ÉDITEUR SQL DE SUPABASE --

-- 1. Tables principales
CREATE TABLE IF NOT EXISTS public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  full_name TEXT,
  email TEXT,
  phone TEXT,
  role TEXT,
  site TEXT,
  permissions JSONB,
  photo_url TEXT,
  date_hired TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.technicians (
  id UUID PRIMARY KEY REFERENCES public.profiles(id) ON DELETE CASCADE,
  name TEXT,
  specialty TEXT,
  status TEXT DEFAULT 'Available',
  site TEXT
);

CREATE TABLE IF NOT EXISTS public.stocks (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT,
  quantity INTEGER DEFAULT 0,
  threshold INTEGER DEFAULT 0,
  unit TEXT,
  site TEXT
);

CREATE TABLE IF NOT EXISTS public.interventions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  site TEXT,
  client TEXT,
  "clientPhone" TEXT,
  location TEXT,
  description TEXT,
  "technicianId" TEXT,
  "technicianName" TEXT,
  date TEXT,
  status TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.reports (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  "technicianName" TEXT,
  date TEXT,
  content TEXT,
  method TEXT,
  site TEXT,
  domain TEXT,
  "interventionType" TEXT,
  location TEXT,
  expenses NUMERIC DEFAULT 0,
  revenue NUMERIC DEFAULT 0,
  "clientName" TEXT,
  "clientPhone" TEXT,
  "audioUrl" TEXT,
  rating NUMERIC,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.daily_stats (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  date TEXT,
  revenue NUMERIC DEFAULT 0,
  interventions INTEGER DEFAULT 0,
  profit NUMERIC DEFAULT 0,
  expenses NUMERIC DEFAULT 0,
  site TEXT
);

-- 2. Tables pour les modules additionnels
CREATE TABLE IF NOT EXISTS public.ticker_messages (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  text TEXT,
  type TEXT,
  display_order INTEGER,
  "isManual" BOOLEAN DEFAULT TRUE
);

CREATE TABLE IF NOT EXISTS public.notifications (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  title TEXT,
  message TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  type TEXT,
  read BOOLEAN DEFAULT FALSE,
  path TEXT
);

CREATE TABLE IF NOT EXISTS public.chantiers (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT,
  client TEXT,
  location TEXT,
  status TEXT,
  budget NUMERIC DEFAULT 0,
  site TEXT,
  "startDate" TEXT
);

CREATE TABLE IF NOT EXISTS public.transactions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  type TEXT,
  amount NUMERIC DEFAULT 0,
  label TEXT,
  category TEXT,
  date TEXT,
  site TEXT
);

CREATE TABLE IF NOT EXISTS public.employees (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  full_name TEXT,
  role TEXT,
  phone TEXT,
  email TEXT,
  site TEXT,
  salary NUMERIC DEFAULT 0,
  date_hired TEXT
);

CREATE TABLE IF NOT EXISTS public.payrolls (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  employee_name TEXT,
  amount NUMERIC DEFAULT 0,
  period TEXT,
  date TEXT,
  status TEXT
);

CREATE TABLE IF NOT EXISTS public.clients (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT,
  phone TEXT,
  email TEXT,
  address TEXT,
  site TEXT,
  type TEXT
);

CREATE TABLE IF NOT EXISTS public.caisse (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  label TEXT,
  amount NUMERIC DEFAULT 0,
  type TEXT,
  date TEXT,
  operator TEXT
);

CREATE TABLE IF NOT EXISTS public.suppliers (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT,
  contact TEXT,
  phone TEXT,
  category TEXT,
  site TEXT
);

CREATE TABLE IF NOT EXISTS public.purchases (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  item_name TEXT,
  supplier TEXT,
  quantity INTEGER DEFAULT 0,
  cost NUMERIC DEFAULT 0,
  date TEXT,
  status TEXT
);

CREATE TABLE IF NOT EXISTS public.materials (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT,
  "serialNumber" TEXT,
  condition TEXT,
  "assignedTo" TEXT,
  site TEXT
);

-- 3. Activation de la sécurité (RLS) et Permissions
-- Permet à l'application de lire et écrire sans restrictions complexes pour le démarrage

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Profiles" ON public.profiles FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE public.technicians ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Technicians" ON public.technicians FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE public.interventions ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Interventions" ON public.interventions FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE public.stocks ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Stocks" ON public.stocks FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE public.daily_stats ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Stats" ON public.daily_stats FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE public.reports ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Reports" ON public.reports FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE public.notifications ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Notifs" ON public.notifications FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE public.ticker_messages ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Ticker" ON public.ticker_messages FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE public.chantiers ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Chantiers" ON public.chantiers FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE public.transactions ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Transactions" ON public.transactions FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE public.employees ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Employees" ON public.employees FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE public.payrolls ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Payrolls" ON public.payrolls FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE public.clients ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Clients" ON public.clients FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE public.caisse ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Caisse" ON public.caisse FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE public.suppliers ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Suppliers" ON public.suppliers FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE public.purchases ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Purchases" ON public.purchases FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE public.materials ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public Materials" ON public.materials FOR ALL USING (true) WITH CHECK (true);
